name: Run CI - Integration Tests

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [master, dev]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  build:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    runs-on: extra-large
    name: Build Project
    steps:
      - name: Checkout this magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator

      - uses: ./magicblock-validator/.github/actions/setup-build-env
        with:
          build_cache_key_name: "magicblock-validator-ci-test-integration-v000-${{ github.sha }}"
          cache_restore_keys: |
            magicblock-validator-ci-test-integration-v000-
            magicblock-validator-ci-test-integration-v000
          rust_toolchain_release: "1.84.1"
          github_access_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./magicblock-validator/.github/actions/setup-solana

      - name: Build project and test programs
        run: |
          cargo build --locked
          make -C test-integration programs
        shell: bash
        working-directory: magicblock-validator

  run_integration_tests:
    needs: build
    runs-on: extra-large
    strategy:
      matrix:
        batch_tests:
          - "schedulecommit"
          - "chainlink"
          - "cloning"
          - "restore_ledger"
          - "magicblock_api"
          - "config"
          - "table_mania"
          - "committor"
          - "pubsub"
          - "schedule_intents"
          - "task-scheduler"
      fail-fast: false
    name: Integration Tests - ${{ matrix.batch_tests }}
    steps:
      - name: Checkout this magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator

      - uses: ./magicblock-validator/.github/actions/setup-build-env
        with:
          build_cache_key_name: "magicblock-validator-ci-test-integration-v000-${{ github.sha }}"
          rust_toolchain_release: "1.84.1"
          github_access_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./magicblock-validator/.github/actions/setup-solana

      - name: Run integration tests - ${{ matrix.batch_tests }}
        run: |
          sudo prlimit --pid $$ --nofile=1048576:1048576
          sudo sysctl fs.inotify.max_user_instances=1280
          sudo sysctl fs.inotify.max_user_watches=655360
          make ci-test-integration
        shell: bash
        working-directory: magicblock-validator
        env:
          RUN_TESTS: ${{ matrix.batch_tests }}
