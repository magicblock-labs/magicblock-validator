name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [master, dev, chore/improve-ci]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/magicblock-labs/magicblock-validator-ci:latest
    # Su push sempre; su PR solo se non è draft
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator
          fetch-depth: 1

      # Nessuna cache: fmt non compila roba pesante

      - name: Run ci-fmt
        run: make ci-fmt
        shell: bash
        working-directory: magicblock-validator

      - name: Run ci-fmt in test-integration
        run: |
          cd test-integration
          make ci-fmt
        shell: bash
        working-directory: magicblock-validator

  lint:
    name: Lint Check
    runs-on: extra-large
    container:
      image: ghcr.io/magicblock-labs/magicblock-validator-ci:latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator
          fetch-depth: 1

      - name: Rust cache (lint)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            magicblock-validator/target
            magicblock-validator/test-integration/target
          # Cache specifica per lint + branch/PR
          key: >
            v1-rust-lint-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-${{ github.head_ref || github.ref_name }}
          # Fallback: stessa Cargo.lock (qualsiasi branch) -> fallback globale OS-based
          restore-keys: |
            v1-rust-lint-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-

      - name: Run ci-lint
        run: make ci-lint
        shell: bash
        working-directory: magicblock-validator

      - name: Run ci-lint in test-integration
        run: |
          cd test-integration
          make ci-lint
        shell: bash
        working-directory: magicblock-validator

  unit-tests:
    name: Unit Tests
    runs-on: extra-large
    container:
      image: ghcr.io/magicblock-labs/magicblock-validator-ci:latest
    # Parte solo dopo format + lint (se uno dei due fallisce, questo job è skipped)
    needs: [format, lint]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator
          fetch-depth: 1

      - name: Rust cache (unit)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            magicblock-validator/target
            magicblock-validator/test-integration/target
          # Cache specifica per unit test + branch/PR
          key: >
            v1-rust-unit-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-${{ github.head_ref || github.ref_name }}
          restore-keys: |
            v1-rust-unit-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-

      - name: Run unit tests
        run: |
          sudo prlimit --pid $$ --nofile=1048576:1048576
          sudo sysctl fs.inotify.max_user_instances=1280
          sudo sysctl fs.inotify.max_user_watches=655360
          make ci-test-unit
        shell: bash
        working-directory: magicblock-validator

  integration-tests:
    name: Integration Tests - ${{ matrix.batch_tests }}
    needs: [format, lint]
    runs-on: extra-large
    container:
      image: ghcr.io/magicblock-labs/magicblock-validator-ci:latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    strategy:
      fail-fast: false
      matrix:
        batch_tests:
          - "schedulecommit"
          - "chainlink"
          - "cloning"
          - "restore_ledger"
          - "magicblock_api"
          - "config"
          - "table_mania"
          - "committor"
          - "pubsub"
          - "schedule_intents"
          - "task-scheduler"
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          path: magicblock-validator
          fetch-depth: 1

      - name: Rust cache (integration)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            magicblock-validator/target
            magicblock-validator/test-integration/target
          # Cache specifica per integration + branch/PR
          key: >
            v1-rust-int-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-${{ github.head_ref || github.ref_name }}
          restore-keys: |
            v1-rust-int-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-${{ hashFiles('magicblock-validator/Cargo.lock') }}-
            v1-rust-${{ runner.os }}-

      - name: Run integration tests - ${{ matrix.batch_tests }}
        run: |
          make ci-test-integration
        shell: bash
        working-directory: magicblock-validator
        env:
          RUN_TESTS: ${{ matrix.batch_tests }}

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs:
      - format
      - lint
      - unit-tests
      - integration-tests
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.format.result }}" != "success" ||
                "${{ needs.lint.result }}" != "success" ||
                "${{ needs.unit-tests.result }}" != "success" ||
                "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "One or more CI jobs failed or were skipped"
            exit 1
          fi
          echo "All CI jobs passed successfully"
