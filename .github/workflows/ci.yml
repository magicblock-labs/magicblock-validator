name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [master, dev, chore/improve-ci]
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

env:
  CARGO_TARGET_DIR: ${{ github.workspace }}/target
  CARGO_BUILD_JOBS: 4

jobs:
  setup-affinity:
    name: Setup Affinity
    runs-on: self-hosted
    outputs:
      runner_idx: ${{ steps.select.outputs.idx }}
    steps:
      - id: select
        run: |
          IDX=$(echo -n "${{ github.ref_name }}" | cksum | awk '{print ($1 % 10) + 1}')
          echo "idx=$IDX" >> $GITHUB_OUTPUT

  format:
    name: Format Check
    needs: setup-affinity
    runs-on: [self-hosted, "self-hosted-${{ needs.setup-affinity.outputs.runner_idx }}"]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Run fmt
        run: |
          make ci-fmt
          cd test-integration && make ci-fmt

  lint:
    name: Lint Check
    needs: setup-affinity
    runs-on: [self-hosted, "self-hosted-${{ needs.setup-affinity.outputs.runner_idx }}"]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Run ci-lint
        run: |
          export RUSTC_WRAPPER=""
          export CARGO_INCREMENTAL=1
          export CARGO_BUILD_JOBS=20 
          make ci-lint
          cd test-integration && make ci-lint

  unit-tests:
    name: Unit Tests
    needs: setup-affinity
    runs-on: [self-hosted, "self-hosted-${{ needs.setup-affinity.outputs.runner_idx }}"]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Run unit tests
        run: RUST_TEST_THREADS=1 make ci-test-unit

  integration-tests:
    name: Integration Tests - ${{ matrix.batch_tests }}
    needs: [setup-affinity, format, lint, unit-tests]
    runs-on: self-hosted
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    strategy:
      fail-fast: false
      matrix:
        batch_tests: ["schedulecommit", "chainlink", "cloning", "restore_ledger", "magicblock_api", "config", "table_mania", "committor", "pubsub", "schedule_intents", "task-scheduler"]
    steps:
      - name: Checkout magicblock-validator
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Run integration tests
        run: |
          export RUSTFLAGS=""
          make ci-test-integration
        env:
          RUN_TESTS: ${{ matrix.batch_tests }}

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    if: always()
    needs: [format, lint, unit-tests, integration-tests]
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.format.result }}" != "success" ||
                "${{ needs.lint.result }}" != "success" ||
                "${{ needs.unit-tests.result }}" != "success" ||
                "${{ needs.integration-tests.result }}" != "success" ]]; then
            exit 1
          fi